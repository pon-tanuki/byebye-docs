# ファイル更新ポリシー

## 概要

本ドキュメントは既存ファイル編集時のルールとセクション内更新方法を定義する。

---

## 既存ファイル編集時のルール

### 基本原則

1. **最小変更の原則**: 必要最小限の変更のみ行う
2. **既存スタイルの尊重**: ファイルの既存フォーマットに従う
3. **バックアップの確保**: 変更前の状態を復元可能にする
4. **テストの維持**: 変更により既存テストが壊れないようにする

### 編集前チェックリスト

| チェック項目 | 確認内容 |
|-------------|---------|
| ファイルの目的 | 変更対象ファイルの役割を理解 |
| 影響範囲 | 変更による影響を特定 |
| 依存関係 | このファイルを参照するコード確認 |
| テスト | 関連テストの存在確認 |
| 権限 | 編集権限があることを確認 |

### 編集の種類と制約

#### 1. 追加（Addition）

```
許可条件:
- 既存のコードを破壊しない
- 既存のインターフェースを変更しない
- テストが追加される

制約:
- ファイル末尾への追加を優先
- 適切な位置への挿入は慎重に
```

#### 2. 修正（Modification）

```
許可条件:
- バグ修正または機能改善が目的
- 既存のテストがパスする
- 破壊的変更でない

制約:
- 変更範囲を最小限に
- 変更理由をコメントで記載
- リファクタリングと機能変更を分離
```

#### 3. 削除（Deletion）

```
許可条件:
- 未使用であることが確認済み
- 参照が存在しない
- テストで確認済み

制約:
- 人間レビュー必須
- 削除理由を記録
- 段階的な削除（非推奨→削除）を推奨
```

---

## セクション内更新方法

### マーカーベースの更新

ファイル内の特定セクションを更新する場合、マーカーを使用する。

#### マーカー形式

```markdown
<!-- AI_EDITABLE_START: section_name -->
このセクションはAIエージェントが更新可能です。
<!-- AI_EDITABLE_END: section_name -->
```

```typescript
// AI_EDITABLE_START: generated_types
// 自動生成されたコード
interface GeneratedType {
  field: string;
}
// AI_EDITABLE_END: generated_types
```

```yaml
# AI_EDITABLE_START: generated_config
# 自動生成された設定
key: value
# AI_EDITABLE_END: generated_config
```

### セクション更新ルール

| ルール | 説明 |
|--------|------|
| マーカー内のみ編集 | マーカー外のコードは編集禁止 |
| マーカーの保持 | マーカー自体を削除・変更しない |
| 完全置換 | セクション内は完全に置換される |
| 整合性維持 | マーカーの開始と終了がペアであること |

### 更新フロー

```
1. ファイル読み込み
   ↓
2. マーカー検出
   ↓
3. 対象セクション特定
   ↓
4. 新しい内容生成
   ↓
5. セクション置換
   ↓
6. 整合性チェック
   ↓
7. ファイル書き込み
```

---

## ファイルタイプ別ルール

### ソースコード（*.ts, *.py, *.go）

```yaml
rules:
  - 型定義の変更は慎重に
  - 公開インターフェースの変更は人間レビュー必須
  - インポート文は整理して保持
  - コメントは更新時に維持
```

### テストファイル（*.test.ts, *.spec.ts）

```yaml
rules:
  - 既存テストは維持
  - 新しいテストは追加のみ
  - テストデータの変更は慎重に
  - describe/itの構造を保持
```

### 設定ファイル（*.json, *.yaml, *.toml）

```yaml
rules:
  - キーの追加は許可
  - 既存キーの値変更は確認必要
  - キーの削除は人間レビュー必須
  - フォーマットを保持
```

### ドキュメント（*.md）

```yaml
rules:
  - セクション追加は許可
  - 既存セクションの編集は内容維持
  - 見出し構造の変更禁止
  - 更新日付を必ず更新
```

---

## コンフリクト解決

### 自動解決可能なケース

| ケース | 解決方法 |
|--------|---------|
| 追加の競合 | 両方の追加を保持 |
| フォーマットの違い | Formatter適用 |
| インポート順序 | 自動ソート |

### 人間介入が必要なケース

| ケース | 対応 |
|--------|------|
| 同一行の異なる変更 | 人間に確認 |
| ロジックの競合 | 人間に確認 |
| 削除と修正の競合 | 人間に確認 |

### コンフリクト報告形式

```markdown
## コンフリクト報告

**ファイル**: path/to/file.ts
**行**: 42-45
**種類**: 同一行の異なる変更

### 現在の内容
```typescript
function example() {
  return "current";
}
```

### 変更しようとした内容
```typescript
function example() {
  return "new";
}
```

### 推奨対応
[人間による判断を推奨する理由]
```

---

## 履歴管理

### 変更追跡

すべての変更は以下の形式で記録：

```yaml
change_record:
  file: "path/to/file.ts"
  timestamp: "2024-01-01T00:00:00Z"
  agent_id: "developer-001"
  task_id: "task-123"
  change_type: "modification"
  summary: "変更内容の要約"
  lines_affected:
    added: 10
    removed: 5
  reason: "変更理由"
```

### ロールバック手順

```
1. 変更前のコミットを特定
2. 影響範囲を確認
3. git revertまたは手動修正
4. テスト実行
5. 変更履歴に記録
```

---

_最終更新日: YYYY-MM-DD_
_更新者: [担当者/AIエージェント名]_
