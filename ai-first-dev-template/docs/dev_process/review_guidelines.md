# レビューガイドライン

## 概要

本ドキュメントはコードレビューの手順と基準を定義する。AI同士のレビュー、およびAI-人間間のレビュープロセスを含む。

---

## AI同士レビューの手順

### レビューフロー

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ Developer Agent │────>│ Reviewer Agent  │────>│  QA Agent       │
│  (コード生成)    │     │  (レビュー)      │     │  (テスト検証)    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
         │                      │                      │
         │                      ▼                      │
         │              ┌─────────────────┐           │
         │              │ 承認 or 修正依頼 │           │
         │              └─────────────────┘           │
         │                      │                      │
         ▼                      ▼                      ▼
┌───────────────────────────────────────────────────────────────┐
│                    Human Reviewer（必要時）                    │
└───────────────────────────────────────────────────────────────┘
```

### レビュー観点

#### 1. Reviewer Agent チェック項目

| カテゴリ | チェック項目 | 自動化 |
|---------|------------|--------|
| 機能性 | 要件との整合性 | 部分的 |
| コード品質 | コーディング規約準拠 | 自動 |
| セキュリティ | 脆弱性パターン検出 | 自動 |
| パフォーマンス | 非効率なパターン検出 | 自動 |
| 保守性 | 複雑度チェック | 自動 |
| テスト | カバレッジ確認 | 自動 |

#### 2. 自動チェックリスト

```yaml
automated_checks:
  - name: "コーディング規約"
    tool: "ESLint / Ruff"
    threshold: "error: 0"

  - name: "型チェック"
    tool: "TypeScript / mypy"
    threshold: "error: 0"

  - name: "セキュリティスキャン"
    tool: "Snyk / Semgrep"
    threshold: "high: 0, critical: 0"

  - name: "テストカバレッジ"
    tool: "Jest / pytest-cov"
    threshold: "80%"

  - name: "循環的複雑度"
    tool: "SonarQube"
    threshold: "15"
```

### レビューコメント形式

#### 必須情報

```markdown
## [SEVERITY] カテゴリ: タイトル

**ファイル**: `path/to/file.ts`
**行**: 42-45

### 指摘内容
[具体的な問題点の説明]

### 提案
[修正案のコード例または説明]

### 参照
- [関連ドキュメント/ルールへのリンク]
```

#### SEVERITY レベル

| レベル | 説明 | 対応 |
|--------|------|------|
| 🔴 BLOCKER | マージ不可の重大な問題 | 必須対応 |
| 🟠 MAJOR | 重要な問題 | 対応推奨 |
| 🟡 MINOR | 軽微な問題 | 任意対応 |
| 🔵 INFO | 情報・提案 | 参考 |

---

## 人間レビューが必要なケース

### 必須ケース

| ケース | 理由 | レビュー観点 |
|--------|------|-------------|
| セキュリティ関連 | リスク軽減 | 脆弱性、認証/認可ロジック |
| 本番デプロイ | 影響範囲 | ロールバック計画、影響確認 |
| アーキテクチャ変更 | 長期影響 | 設計妥当性、拡張性 |
| 外部API連携 | 依存関係 | 契約、エラー処理 |
| データモデル変更 | データ整合性 | マイグレーション計画 |
| 新規依存関係追加 | ライセンス/セキュリティ | ライセンス確認、脆弱性 |

### 推奨ケース

| ケース | 理由 | レビュー観点 |
|--------|------|-------------|
| 複雑なビジネスロジック | 要件理解 | 仕様との整合性 |
| パフォーマンスクリティカル | 運用影響 | 負荷テスト結果 |
| ユーザー向けUI変更 | UX | デザイン一貫性 |
| エラーハンドリング変更 | 運用 | エラーメッセージ適切性 |

### エスカレーションフロー

```
AI Reviewer 検出
      │
      ▼
┌─────────────────┐
│ 問題の分類      │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
[自動対応可]  [人間判断必要]
    │              │
    ▼              ▼
[修正依頼]    [エスカレーション]
                   │
                   ▼
         ┌─────────────────┐
         │ 人間レビュアー   │
         │ への通知         │
         └─────────────────┘
```

---

## レビュープロセス

### 1. PR作成時

1. AIエージェントがPRを作成
2. 自動チェックが実行
3. Reviewer Agent が割り当て
4. 自動レビューコメント生成

### 2. レビュー実施

1. 自動チェック結果の確認
2. コード変更の分析
3. レビューコメントの作成
4. 承認または修正依頼

### 3. 修正対応

1. Developer Agent が修正実施
2. 修正コミット
3. 再レビュー
4. 繰り返し（最大3回、それ以上は人間介入）

### 4. 承認・マージ

1. 全チェックパス確認
2. 必要な承認数の確認
3. マージ実行
4. ブランチ削除

---

## レビューメトリクス

### 計測項目

| メトリクス | 目標 | 計測方法 |
|-----------|------|---------|
| レビュー所要時間 | < 4時間 | PR作成からレビュー完了まで |
| 修正回数 | < 2回 | PR内の修正コミット数 |
| 人間介入率 | < 20% | 人間レビュー必要なPR割合 |
| 自動検出率 | > 90% | 自動で検出された問題の割合 |

### 改善サイクル

```
1. メトリクス収集
   ↓
2. 傾向分析
   ↓
3. ルール/チェック改善
   ↓
4. 効果測定
   ↓
（繰り返し）
```

---

## レビュアー割り当てルール

### 自動割り当て条件

```yaml
assignment_rules:
  - condition: "changes include security/*"
    assign: ["security-team", "human-reviewer"]
    required_approvals: 2

  - condition: "changes include api/*"
    assign: ["api-reviewer-agent"]
    required_approvals: 1

  - condition: "file_count > 20"
    assign: ["human-reviewer"]
    required_approvals: 1

  - condition: "default"
    assign: ["reviewer-agent"]
    required_approvals: 1
```

---

_最終更新日: YYYY-MM-DD_
_更新者: [担当者/AIエージェント名]_
