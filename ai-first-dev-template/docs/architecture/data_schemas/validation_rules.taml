# バリデーションルール定義
# Format: TAML (Text-based Application Markup Language)

version: "1.0"
last_updated: "YYYY-MM-DD"

# =============================================================================
# 入力チェックルール
# =============================================================================

input_validations:

  # ---------------------------------------------------------------------------
  # 共通バリデーション
  # ---------------------------------------------------------------------------
  common:
    - id: V001
      name: "UUID形式チェック"
      rule: regex
      pattern: "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
      error_message: "無効なID形式です"

    - id: V002
      name: "メールアドレス形式"
      rule: regex
      pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
      error_message: "無効なメールアドレス形式です"

    - id: V003
      name: "日付形式（ISO 8601）"
      rule: regex
      pattern: "^\\d{4}-\\d{2}-\\d{2}$"
      error_message: "日付はYYYY-MM-DD形式で入力してください"

    - id: V004
      name: "日時形式（ISO 8601）"
      rule: regex
      pattern: "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{3})?Z?$"
      error_message: "日時はISO 8601形式で入力してください"

  # ---------------------------------------------------------------------------
  # User バリデーション
  # ---------------------------------------------------------------------------
  user:
    - id: V100
      field: email
      rules:
        - type: required
          error_message: "メールアドレスは必須です"
        - type: max_length
          value: 255
          error_message: "メールアドレスは255文字以内で入力してください"
        - type: format
          ref: V002

    - id: V101
      field: name
      rules:
        - type: required
          error_message: "名前は必須です"
        - type: min_length
          value: 1
          error_message: "名前は1文字以上で入力してください"
        - type: max_length
          value: 100
          error_message: "名前は100文字以内で入力してください"

    - id: V102
      field: password
      rules:
        - type: required
          error_message: "パスワードは必須です"
        - type: min_length
          value: 8
          error_message: "パスワードは8文字以上で入力してください"
        - type: regex
          pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d).+$"
          error_message: "パスワードは大文字、小文字、数字を含む必要があります"

  # ---------------------------------------------------------------------------
  # Task バリデーション
  # ---------------------------------------------------------------------------
  task:
    - id: V200
      field: title
      rules:
        - type: required
          error_message: "タイトルは必須です"
        - type: min_length
          value: 1
          error_message: "タイトルは1文字以上で入力してください"
        - type: max_length
          value: 200
          error_message: "タイトルは200文字以内で入力してください"

    - id: V201
      field: description
      rules:
        - type: max_length
          value: 10000
          error_message: "説明は10000文字以内で入力してください"

    - id: V202
      field: due_date
      rules:
        - type: format
          ref: V003
        - type: custom
          name: future_date
          error_message: "期限は現在日時以降を設定してください"

# =============================================================================
# ビジネスルール
# =============================================================================

business_rules:

  # ---------------------------------------------------------------------------
  # タスク関連ルール
  # ---------------------------------------------------------------------------
  task:
    - id: BR001
      name: "タスクステータス遷移"
      description: "タスクのステータスは特定の順序でのみ変更可能"
      rule: |
        allowed_transitions:
          todo: [in_progress]
          in_progress: [review, todo]
          review: [done, in_progress]
          done: [in_progress]  # 再オープン可能
      error_message: "無効なステータス遷移です"

    - id: BR002
      name: "AIエージェント割り当て制限"
      description: "高優先度タスクのAIエージェント単独割り当ては禁止"
      rule: |
        if task.priority == 'high' and task.assignee_type == 'ai_agent':
          require human_reviewer
      error_message: "高優先度タスクには人間レビュアーが必要です"

    - id: BR003
      name: "完了タスクの編集制限"
      description: "完了済みタスクの内容編集には権限が必要"
      rule: |
        if task.status == 'done':
          require role in [admin, developer]
      error_message: "完了済みタスクの編集には権限が必要です"

  # ---------------------------------------------------------------------------
  # プロジェクト関連ルール
  # ---------------------------------------------------------------------------
  project:
    - id: BR100
      name: "プロジェクト削除条件"
      description: "進行中タスクがあるプロジェクトは削除不可"
      rule: |
        if project.has_tasks_with_status('in_progress'):
          deny delete
      error_message: "進行中のタスクがあるプロジェクトは削除できません"

    - id: BR101
      name: "アーカイブ条件"
      description: "全タスク完了後のみアーカイブ可能"
      rule: |
        if project.has_incomplete_tasks():
          deny archive
      error_message: "未完了タスクがあるプロジェクトはアーカイブできません"

  # ---------------------------------------------------------------------------
  # AIエージェント関連ルール
  # ---------------------------------------------------------------------------
  ai_agent:
    - id: BR200
      name: "同時実行制限"
      description: "1つのAIエージェントは同時に1タスクのみ実行可能"
      rule: |
        if agent.current_task_count >= 1:
          deny new_task_assignment
      error_message: "エージェントは既にタスクを実行中です"

    - id: BR201
      name: "本番デプロイ禁止"
      description: "AIエージェント単独での本番デプロイは禁止"
      rule: |
        if action == 'deploy_production':
          require human_approval
      error_message: "本番デプロイには人間の承認が必要です"

    - id: BR202
      name: "機密データアクセス制限"
      description: "AIエージェントの機密データへのアクセスはログ必須"
      rule: |
        if accessing sensitive_data:
          require audit_log
          require encryption
      error_message: "機密データアクセスにはログ記録が必要です"

# =============================================================================
# エラーコード定義
# =============================================================================

error_codes:
  - code: E001
    type: validation
    message: "入力値が不正です"
  - code: E002
    type: validation
    message: "必須項目が未入力です"
  - code: E003
    type: business
    message: "ビジネスルール違反です"
  - code: E004
    type: authorization
    message: "権限がありません"
  - code: E005
    type: conflict
    message: "リソースの競合が発生しました"
